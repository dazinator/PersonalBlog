<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="">
    <meta property="og:title" content="Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 4">
    

  
  
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="og:image" content="http://darrelltunnell.net/img/new-aspnetcore-project.PNG"/>
    <meta name="twitter:card" content="summary"/>
  
  
  <meta name="twitter:title" content="Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 4"/>
  <meta name="twitter:description" content="In previous tutorials we have seen how to configure an asp.net core application for multiple tenants, which included setting up the Moogle and Gicrosoft tenants.
In this tutorial, we will allow each tenant to have it&rsquo;s own middleware pipeline. This allows us to precisely control which middlware runs for which tenants!
This feature is sometimes referred to as Per Tenant Middleware in ASP.NET Core.

This is part of a series. You can find the other parts here
You can find the sample code for this post here
"/>
  
    <meta name="twitter:site" content="@dazinator"/>
  
  
  

    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2017-10-01">
    
    <meta property="og:description" content="">
    <meta property="og:url" content="http://darrelltunnell.net/tutorial/creating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-4/">
    <meta property="og:site_name" content="Darrell Tunnell">
    
    <meta property="og:tags" content="dotnettency">
    
    <meta property="og:tags" content="asp.net core">
    
    <meta property="og:tags" content="multitenancy">
    
    <meta property="og:tags" content="aspnetcore">
    
    <meta property="og:tags" content="middleware">
    
    <meta name="generator" content="Hugo 0.29" />
    <title>Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 4 &middot; Darrell Tunnell</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="http://darrelltunnell.net/css/style.css">    
    
    <link href="" rel="alternate" type="application/rss+xml" title="Darrell Tunnell" />
    
    
    <link rel="icon" href="http://darrelltunnell.net/favicon.ico" />
    
    <style>
     
.highlight pre {
    word-wrap: normal;
}

.highlight pre code {
    white-space: pre;
}

    </style>

    
    
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://darrelltunnell.net/">Darrell Tunnell</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="http://darrelltunnell.net/">Home</a></li>
				
					<li><a href="http://darrelltunnell.net/post/">Posts</a></li>
				
					<li><a href="http://darrelltunnell.net/tutorial/">Tutorials</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="http://darrelltunnell.net/">Darrell Tunnell</a></h1>
		
		
		
			<small class="text-center center-block">Radiating Awesomeness, One Blog Post at a Time.</small>
		
		
		
			<img id="profile-pic" src="http://darrelltunnell.net//img/profile.jpg" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			
				<a href="https://github.com/dazinator"><i class="fa fa-github fa-2x"></i></a>
			
				<a href="https://twitter.com/dazinate"><i class="fa fa-twitter fa-2x"></i></a>
			
				<a href="https://uk.linkedin.com/in/darrell-tunnell-33845331"><i class="fa fa-linkedin fa-2x"></i></a>
			
				<a href="http://darrelltunnell.net/index.xml"><i class="fa fa-rss-square fa-2x"></i></a>
			

			<a href="mailto:darrelltunnell@gmail.com"><i class="fa fa-envelope-o fa-2x"></i></a>
		</div>
		<div id="links" class="text-center">
			
			
				<a href="http://darrelltunnell.net/">Home</a>
			
				<a href="http://darrelltunnell.net/post/">Posts</a>
			
				<a href="http://darrelltunnell.net/tutorial/">Tutorials</a>
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1>Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 4</h1>
	</header>

	<article>
		<p>In <a href="http://darrelltunnell.net/tags/dotnettency/">previous tutorials</a> we have seen how to configure an asp.net core application for multiple tenants, which included setting up the <code>Moogle</code> and <code>Gicrosoft</code> tenants.
In this tutorial, we will allow each tenant to have it&rsquo;s own middleware pipeline. This allows us to precisely control which middlware runs for which tenants!
This feature is sometimes referred to as <code>Per Tenant Middleware</code> in ASP.NET Core.</p>

<p><em>This is part of a series. <a href="http://darrelltunnell.net/tags/dotnettency/">You can find the other parts here</a></em>
<em>You can find the sample code for this post <a href="https://github.com/dazinator/Dotnettency.Samples">here</a></em>
</p>

<h2 id="per-tenant-middleware-you-say">Per Tenant Middleware you say?</h2>

<p>Suppose you have some middleware, like:</p>

<ul>
<li><code>UseWelcomePage</code></li>
<li><code>UseMvc</code></li>
<li><code>UseBlah</code></li>
</ul>

<p>Great! But your application is also used by multiple Tenants. You would like to enable the welcome page middleware for one of those tenants but not for the others!
Let&rsquo;s see how the <code>Dotnettency.MiddlewarePipeline</code> nuget package is your friend!</p>

<h2 id="welcome-moogle">Welcome Moogle!</h2>

<p>We are goiing to call the <code>UseWelcomePage()</code> on an <code>IApplicationBuilder</code> to add the <code>WelcomePage</code> middleware - nothing unusual here. The only difference is,
the <code>IApplicationBuilder</code> we call this on will be for the <code>Moogle</code> Tenant. The <code>Gicrosoft</code> tenant will remain unaffected.</p>

<ol>
<li>Ensure you have a <code>Package Reference</code> to <a href="https://www.nuget.org/packages/Dotnettency.MiddlewarePipeline/">Dotnettency.MiddlewarePipeline</a> nuget package,</li>

<li><p>In <code>startup.cs</code> in <code>ConfigureServices()</code> - find your call to <code>AddMultiTenancy()</code> as per the below:
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"><code class="language-csharp" data-lang="csharp"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</code></pre></div></td><td class="code"><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-csharp" data-lang="csharp"><span></span>        <span style="color: #408080; font-style: italic">// This method gets called by the runtime. Use this method to add services to the container.</span>
        <span style="color: #408080; font-style: italic">// For more information on how to configure your application, visit https://go.microsoft.com/fwlink/?LinkID=398940</span>
        <span style="color: #008000; font-weight: bold">public</span> IServiceProvider <span style="color: #0000FF">ConfigureServices</span>(IServiceCollection services)
        {
            <span style="color: #008000; font-weight: bold">return</span> services.AddMultiTenancy&lt;Tenant&gt;((multiTenancyOptions) =&gt;
            {
                multiTenancyOptions
                    .InitialiseTenant&lt;TenantShellFactory&gt;()
                    .ConfigureTenantContainers((containerBuilder)=&gt; {
                        containerBuilder.WithStructureMap((tenant, tenantServices) =&gt;
                        {

                        });
                    })
                    .ConfigureTenantMiddleware((tenantsMiddlewareBuilder) =&gt;
                    {
                        tenantsMiddlewareBuilder.OnInitialiseTenantPipeline((context, appBuilder) =&gt;
                        {
                           
                        });
                    });
            });
        }
</code></pre></div>
</td></tr></table></p></li>

<li><p>Inside <code>ConfigureTenantMiddleware</code> is where we can add any tenant specific middleware. If the above seems unfamiliar to you, please refer to the <a href="http://darrelltunnell.net/tags/dotnettency/">previous tutorials</a>. Let&rsquo;s add the <code>WelcomePage</code> middleware for the <code>Moogle</code> tenant:
<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"><code class="language-csharp" data-lang="csharp"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</code></pre></div></td><td class="code"><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><code class="language-csharp" data-lang="csharp"><span></span>                    .ConfigureTenantMiddleware((tenantsMiddlewareBuilder) =&gt;
                    {
                        tenantsMiddlewareBuilder.OnInitialiseTenantPipeline((context, appBuilder) =&gt;
                        {
                            <span style="color: #008000; font-weight: bold">if</span> (context.Tenant.Name == <span style="color: #BA2121">&quot;Moogle&quot;</span>)
                            {
                                appBuilder.UseWelcomePage();
                            }
                        });
                    });                            
</code></pre></div>
</td></tr></table></p></li>
</ol>

<p>I won&rsquo;t cover the <code>TenantShellFactory</code> in this tutorial as it has already been <a href="http://darrelltunnell.net/tags/dotnettency/">covered previously</a>. Suffice it to say that
this class is responsible for identifying who the current Tenant is, based on the URL or any other accessible value. In our sample we have mapped
<code>localhost:5000</code> to the <code>Moogle</code> Tenant and <code>localhost:5002</code> to <code>Gicrosoft</code> Tenant.</p>

<p>If we run the application, and browse on <code>localhost:5000</code> (i.e <code>Moogle</code>) we get:</p>

<p><img src="http://darrelltunnell.net/img/hellopagemiddleware.PNG" alt="hellopagemiddleware.PNG" /></p>

<p>Success! That&rsquo;s a beautiful looking welcome page. Very blue.</p>

<p>If we browse our application on <code>localhost:5002</code> we get:</p>

<p><img src="http://darrelltunnell.net/img/error500.PNG" alt="error500.PNG" /></p>

<p>Hurray! This means our middleware is only running for the Tenant we wanted it to run for!</p>

<p>Furthermore, this works with any existing asp.net core <code>Middleware</code> today. The middleware does not have to be written with multitenancy in mind in any way.</p>

<h2 id="what-s-next">What&rsquo;s next?</h2>

<p>Have any multitenant scenarios you want me to cover for asp.net core? Let me know!
Stay tuned for:</p>

<ol>
<li>Per Tenant <code>IHostingEnvironment</code> (each tenant has its own virtual file system)</li>
<li>Modules (Shared and Routed)</li>
</ol>

<p>Don&rsquo;t forget to leave a comment if you find this stuff useful!</p>

<p><em>This is part of a series. <a href="http://darrelltunnell.net/tags/dotnettency/">You can find the other parts here</a></em>
<em>You can find the sample code for this post <a href="https://github.com/dazinator/Dotnettency.Samples">here</a></em></p>
	</article>
</main>

 <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Modular%2c%20Multi-tenant%2c%20ASP.NET%20Core%20Applications%20with%20Dotnettency%20-%20Part%204&url=http%3a%2f%2fdarrelltunnell.net%2ftutorial%2fcreating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-4%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=http%3a%2f%2fdarrelltunnell.net%2ftutorial%2fcreating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-4%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
            <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&title=Modular%2c%20Multi-tenant%2c%20ASP.NET%20Core%20Applications%20with%20Dotnettency%20-%20Part%204&url=http%3a%2f%2fdarrelltunnell.net%2ftutorial%2fcreating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-4%2f&summary="
               onclick="window.open(this.href, 'linkedin-share', 'width=554,height=481');return false;">
               <i class="fa fa-linkedin"></i>
               <span class="hidden">LinkedIn</span>
            </a>
        
    </div>

<div id="bottom-nav" class="text-center center-block">
	<a href=" http://darrelltunnell.net/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "darrelltunnellsblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


						</div>
					</div>
				</div>
			</div>
    </div>
  
 
  
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'code-here', 'auto');
    ga('send', 'pageview');
    window.baseURL = "http:\/\/darrelltunnell.net\/";
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  
  
  <script src="http://darrelltunnell.net//js/App.js"></script>
  
  <script type="text/javascript">   
  $(document).ready(function () {
	$( ".highlighttable" ).wrap("<div class='table-responsive'></div>");
  $( "img" ).addClass("img-responsive");
});
</script>
    
</body>
</html>
