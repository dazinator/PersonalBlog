<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="">
    <meta property="og:title" content="Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 3">
    

  
  
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="og:image" content="http://darrelltunnell.net/img/new-aspnetcore-project.PNG"/>
    <meta name="twitter:card" content="summary"/>
  
  
  <meta name="twitter:title" content="Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 3"/>
  <meta name="twitter:description" content="This is part of a series. You can find the other parts here

You can find the sample code for this post here

In this part of the tutorial, we will cover Per Tenant DI Containers in ASP.NET Core.
"/>
  
    <meta name="twitter:site" content="@dazinator"/>
  
  
  

    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2017-08-24">
    
    <meta property="og:description" content="">
    <meta property="og:url" content="http://darrelltunnell.net/tutorial/creating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-3/">
    <meta property="og:site_name" content="Darrell Tunnell">
    
    <meta property="og:tags" content="dotnettency">
    
    <meta property="og:tags" content="asp.net core">
    
    <meta property="og:tags" content="multitenancy">
    
    <meta property="og:tags" content="aspnetcore">
    
    <meta name="generator" content="Hugo 0.25.1" />
    <title>Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 3 &middot; Darrell Tunnell</title>
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    
    <link rel="stylesheet" href="http://darrelltunnell.net/css/style.css">
    
    <link href="" rel="alternate" type="application/rss+xml" title="Darrell Tunnell" />
    
    
    <link rel="icon" href="http://darrelltunnell.net/favicon.ico" />
    
    <style>
     
.highlight pre {
    word-wrap: normal;
}

.highlight pre code {
    white-space: pre;
}

    </style>

    
    
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://darrelltunnell.net/">Darrell Tunnell</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
					<li><a href="http://darrelltunnell.net/">Blog</a></li>
				
					<li><a href="http://darrelltunnell.net/post/">Posts</a></li>
				
					<li><a href="http://darrelltunnell.net/tutorial/">Tutorials</a></li>
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="menu-content" class="vertical-align">
		
			<h1 class="text-center"><a href="http://darrelltunnell.net/">Darrell Tunnell</a></h1>
		
		
		
			<small class="text-center center-block">Developer Extraordinaire</small>
		
		
		
			<img id="profile-pic" src="http://darrelltunnell.net//img/profile.jpg" alt="My Picture" class="img-circle center-block">
		
		<div id="social" class="text-center">
			
				<a href="https://github.com/dazinator"><i class="fa fa-github fa-2x"></i></a>
			
				<a href="https://twitter.com/dazinate"><i class="fa fa-twitter fa-2x"></i></a>
			
				<a href="https://uk.linkedin.com/in/darrell-tunnell-33845331"><i class="fa fa-linkedin fa-2x"></i></a>
			

			<a href="mailto:darrelltunnell@gmail.com"><i class="fa fa-envelope-o fa-2x"></i></a>
		</div>
		<div id="links" class="text-center">
			
			
				<a href="http://darrelltunnell.net/">Blog</a>
			
				<a href="http://darrelltunnell.net/post/">Posts</a>
			
				<a href="http://darrelltunnell.net/tutorial/">Tutorials</a>
			
		</div>
	</div>
</div>

		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<h1>Modular, Multi-tenant, ASP.NET Core Applications with Dotnettency - Part 3</h1>
	</header>

	<article>
		<p><em>This is part of a series. <a href="http://darrelltunnell.net/tags/dotnettency/">You can find the other parts here</a></em></p>

<p><em>You can find the sample code for this post <a href="https://github.com/dazinator/Dotnettency.Samples">here</a></em></p>

<p>In this part of the tutorial, we will cover <code>Per Tenant DI Containers</code> in ASP.NET Core.
</p>

<h2 id="per-tenant-containers-an-unfriendly-greeting">Per Tenant Containers - An Unfriendly Greeting</h2>

<p>Dotnettency allows you to configure <code>Per Tenant</code> DI Containers. The easiest way to understand this is to see it in action. Before proceeding you should ideally be familiar with basic tenant resolution <a href="http://darrelltunnell.net/tags/dotnettency/">from the previous tutorials</a></p>

<p>In <code>startup.cs</code></p>

<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>        <span style="color: #008000; font-weight: bold">public</span> IServiceProvider <span style="color: #0000FF">ConfigureServices</span>(IServiceCollection services)
        {
            <span style="color: #008000; font-weight: bold">return</span> services.AddMultiTenancy&lt;Tenant&gt;((multiTenancyOptions) =&gt;
            {
                multiTenancyOptions
                    .InitialiseTenant&lt;TenantShellFactory&gt;()
                    .ConfigureTenantContainers((containerBuilder) =&gt;
                    {
                        containerBuilder.WithStructureMap((tenant, tenantServices) =&gt;
                        {
                            <span style="color: #008000; font-weight: bold">if</span> (tenant.Name == <span style="color: #BA2121">&quot;Moogle&quot;</span>)
                            {
                                tenantServices.AddSingleton&lt;GreetingService&gt;(<span style="color: #008000; font-weight: bold">new</span> GreetingService(<span style="color: #008000; font-weight: bold">true</span>));
                            }
                            <span style="color: #008000; font-weight: bold">else</span>
                            {
                                tenantServices.AddSingleton&lt;GreetingService&gt;(<span style="color: #008000; font-weight: bold">new</span> GreetingService(<span style="color: #008000; font-weight: bold">false</span>));
                            }
                        });
                    });
            });
</pre></div>
</td></tr></table>

<p>We are registering the <code>GreetingService</code> differently for the <code>Moogle</code> tenant than the other tenants.</p>

<p>The <code>GreetingService</code> looks like this:</p>

<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">GreetingService</span>
    {
        <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">readonly</span> <span style="color: #B00040">bool</span> _isVisitorWelcome;

        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">GreetingService</span>(<span style="color: #B00040">bool</span> isVisitorWelcome)
        {
            _isVisitorWelcome = isVisitorWelcome;
        }

        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">string</span> <span style="color: #0000FF">Greet</span>()
        {
            <span style="color: #008000; font-weight: bold">if</span> (_isVisitorWelcome)
            {
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;WILL YOU GO AWAY ALREADY!!&quot;</span>;
            }
            <span style="color: #008000; font-weight: bold">else</span>
            {
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;Pleased to meet you.&quot;</span>;
            }
        }

    }
</pre></div>
</td></tr></table>

<p>Next, we need to include the <code>dotnettency middleware</code> by adding a call to <code>options.UsePerTenantContainers();</code> and also we will resolve the <code>GreetingService</code> and write it&rsquo;s message in the response:</p>

<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>         <span style="color: #408080; font-style: italic">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span>
        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">void</span> <span style="color: #0000FF">Configure</span>(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
        {
            loggerFactory.AddConsole();

            <span style="color: #008000; font-weight: bold">if</span> (env.IsDevelopment())
            {
                app.UseDeveloperExceptionPage();
            }

            app.UseMultitenancy&lt;Tenant&gt;((options) =&gt;
            {
                options.UsePerTenantContainers();
            });

            app.Run(<span style="color: #008000; font-weight: bold">async</span> (context) =&gt;
            {
                <span style="color: #B00040">var</span> greetingService = context.RequestServices.GetRequiredService&lt;GreetingService&gt;();
                <span style="color: #008000; font-weight: bold">await</span> context.Response.WriteAsync(greetingService.Greet());
            });

        }
</pre></div>
</td></tr></table>

<p>Now browse to the site for each Tenant. See the previous tutorial if you would like to recap on that. Let&rsquo;s see the greeting for the <code>Moogle</code> tenant:</p>

<p><img src="http://darrelltunnell.net/img/dotnettencygreetingmoogle.PNG" alt="dotnettencygreetingmoogle.PNG" /></p>

<p>Quite unfriendly.</p>

<p>How about other tenants:</p>

<p><img src="http://darrelltunnell.net/img/dotnettencygreetinggicrosoft.PNG" alt="dotnettencygreetinggicrosoft.PNG" /></p>

<p>Well, they are still valued.</p>

<p>If you are having any issues, you can look at the full <a href="https://github.com/dazinator/Dotnettency.Samples">sample code here</a>)</p>

<h2 id="how-does-it-work">How does it work?</h2>

<p>ASP.NET Core applications allow you to configure the main application container on startup, in <code>ConfigureServices()</code>:</p>

<table class="highlighttable"><tr><td><div class="linenodiv" style="background-color: #f0f0f0; padding-right: 10px"><pre style="line-height: 125%">1
2
3
4</pre></div></td><td class="code"><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>        <span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">void</span> <span style="color: #0000FF">ConfigureServices</span>(IServiceCollection services)
        {
             services.AddTransient&lt;FooService&gt;();
        }
</pre></div>
</td></tr></table>

<p>When a request arrives, there is some middleware that sits at the entry point of the pipeline, which creates a nested / scoped version of the container for the request, which is stored in <code>HttpContext.RequestServices</code>. This nested / scoped version of the application container is disposed of at the end of the request.</p>

<p>Dotnettency <code>Tenant Containers</code> allow you to go a step further. It will create a &ldquo;child&rdquo; container for each tenant. It restores the current tenants container into <code>HttpContext.RequestServices</code> during the request. The tenant container, is intiialised when the first request for the tenant is received. You can register services into the tenant&rsquo;s container, just like you can for the main application container. As the tenant container is a child container of the main application container, it means when a service is unable to be resolved from the tenant&rsquo;s container, it will bubble up to the main application container for resolution. This enables some useful scenarios:</p>

<ol>
<li>You can register default services in your main application container, and then override them on a per tenant basis as needed.</li>
<li>You can register a service only for particular tenants, so the service cannot be resolved for other tenants at all.</li>
<li>You can register a service for each tenant, but with options tailored for that tenant.</li>
</ol>

<p>Some examples are:</p>

<ol>
<li>You may want all tenants by default to use third party authentication services like Google, Microsoft etc but allow tenants to enable / disable them on an individual basis.</li>
<li>You may want one tenant to have Cookie Authentication and not any others.</li>
<li>You may want each tenant to have an <code>SmtpService</code> that is configured with an smtp server address for the that tenant.</li>
</ol>

<h2 id="interesting-implications">Interesting implications</h2>

<p>You can use this to add and configure entire frameworks differently per tenant. For example, if you want a multi-tenant MVC application, you could <code>AddMvc()</code> into each Tenant&rsquo;s container so that you can configure MVC on a per tenant basis. If you do decide to take this approach, you will also need to add any middleware that the framework provides (i.e <code>UseMvc</code>), into the <code>Per Tenant Middleware Pipeline</code> rather than the main application <code>Middleware Pipeline</code>. We will discuss the <code>Per Tenant Middleware Pipeline</code> in the next tutorial.</p>

<h2 id="what-s-next">What&rsquo;s next?</h2>

<p>Stay tuned for:</p>

<ol>
<li>Per Tenant <code>Middleware Pipeline</code></li>
<li>Per Tenant <code>IHostingEnvironment</code> (for sandboxing file access)</li>
<li>Modules (Shared and Routed)</li>
</ol>

<p>Don&rsquo;t forget to leave a comment if you find this stuff useful!</p>

<p><em>This is part of a series. <a href="http://darrelltunnell.net/tags/dotnettency/">You can find the other parts here</a></em></p>

<p><em>You can find the sample code for this post <a href="https://github.com/dazinator/Dotnettency.Samples">here</a></em></p>
	</article>
</main>

 <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Modular%2c%20Multi-tenant%2c%20ASP.NET%20Core%20Applications%20with%20Dotnettency%20-%20Part%203&url=http%3a%2f%2fdarrelltunnell.net%2ftutorial%2fcreating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-3%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=http%3a%2f%2fdarrelltunnell.net%2ftutorial%2fcreating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-3%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
            <a class="icon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&title=Modular%2c%20Multi-tenant%2c%20ASP.NET%20Core%20Applications%20with%20Dotnettency%20-%20Part%203&url=http%3a%2f%2fdarrelltunnell.net%2ftutorial%2fcreating-modular-multi-tenant-asp-net-core-application-with-dotnettency-part-3%2f&summary="
               onclick="window.open(this.href, 'linkedin-share', 'width=554,height=481');return false;">
               <i class="fa fa-linkedin"></i>
               <span class="hidden">LinkedIn</span>
            </a>
        
    </div>

<div id="bottom-nav" class="text-center center-block">
	<a href=" http://darrelltunnell.net/" class="btn btn-default"><i class="fa fa-home"></i> Home</a>
</div>


  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "darrelltunnellsblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


						</div>
					</div>
				</div>
			</div>
    </div>
  
 
  
  <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'code-here', 'auto');
    ga('send', 'pageview');
    window.baseURL = "http:\/\/darrelltunnell.net\/";
  </script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.6.9/topojson.min.js"></script>
  
  
  <script src="http://darrelltunnell.net//js/App.js"></script>
  
  <script type="text/javascript">   
  $(document).ready(function () {
	$( ".highlighttable" ).wrap("<div class='table-responsive'></div>");
  $( "img" ).addClass("img-responsive");
});
</script>
    
</body>
</html>
