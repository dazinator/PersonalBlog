<!DOCTYPE html>
<html lang="en-gb">
<head>
    <title>CSLA and ASP.NET Core</title>
    <meta name="generator" content="Hugo 0.29" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
    

    <script src="http://darrelltunnell.net/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="http://darrelltunnell.net/bower_components/bootstrap/js/bootstrap.min.js"></script>
    <script src="http://darrelltunnell.net/bower_components/bootstrap/js/dropdowns-enhancement.js"></script>
    <script src="http://darrelltunnell.net/bower_components/bluebird/js/browser/bluebird.js"></script>
    <script src="http://darrelltunnell.net//bower_components/talaria/dist/talaria.js"></script>
    <script src="http://darrelltunnell.net/bower_components/d3/d3.min.js" charset="utf-8"></script>
    <script src="http://darrelltunnell.net/bower_components/cal-heatmap/cal-heatmap.min.js"></script>
    <script src="http://darrelltunnell.net/bower_components/highlightjs/highlight.pack.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']]}
      });
    </script>

    <link rel="icon" href="http://darrelltunnell.net/favicon.ico" />
    <link rel="apple-touch-icon" href="http://darrelltunnell.net/apple-touch-icon.png" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/highlightjs/styles/monokai.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/bootstrap/css/dropdowns-enhancement.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/talaria/dist/talaria.css" />   
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/createjs/createjs.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/icomoon/css/icomoon.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/css/style.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/css/mobile.css" />
    <link rel="stylesheet" href="http://darrelltunnell.net/bower_components/cal-heatmap/cal-heatmap.css" />

    

    
</head>
<body>
<div class="container">



<header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">

	<nav class="navbar navbar-default">
	  <div class="container-fluid">

    	    <div class="navbar-header">
      		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
      		  <span class="sr-only">Toggle navigation</span>
      		  <span class="icon-bar"></span>
      		  <span class="icon-bar"></span>
      		  <span class="icon-bar"></span>
      		</button>
		    <h1>
			    <a class="navbar-brand" href="http://darrelltunnell.net/">
				    <span class="icon-phoenix_logo"></span>
				    
				    
				    
			    </a>
		    </h1>
	    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
    
        <li><a href="#">Home</a></li>
        <li><a href="http://darrelltunnell.net/hugo-theme-wave/archive">Archives</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Wiki<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#">User</a></li>
            <li role="separator" class="divider"></li>
            <li class="dropdown-submenu">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Application</a>
            <ul class="dropdown-menu">
              <li><a href="#">List Application</a></li>
                    <li role="separator" class="divider"></li>
              <li><a href="#">Accessibility</a></li>
              <li><a href="#">Application launchers</a></li>
              <li class="dropdown-submenu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Command shells</a>
              <ul class="dropdown-menu">
                <li class="dropdown-submenu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Bash</a>
                <ul class="dropdown-menu">
                  <li><a href="#">Invocation</a></li>
                  <li><a href="#">Command line</a></li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
            <li><a href="#">Development</a></li>
            <li><a href="#">Hardware</a></li>
            <li><a href="#">Networking</a></li>
            <li><a href="#">System administration</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">GitHub</a></li>
          </ul>
        </li>
        <li><a href="#">Issue</a></li>

    <li>
	<a href="https://gitlab.com/">
		<i class="fa fa-gitlab" aria-hidden="true"></i>
	</a>
</li>
<li>
	<a href="https://github.com/">
		<i class="fa fa-github" aria-hidden="true"></i>
	</a>
</li>
<li>
	<a href="https://twitter.com/">
		<i class="fa fa-twitter" aria-hidden="true"></i>
	</a>

</li>

<li>
	<a href="">
		 <i class="fa fa-rss-square" aria-hidden="true"></i>
	</a>
</li>

    
      </ul>
    </div>

  </div>
</nav>

</header>




<div id="container">
   <div class="outer">
    <section id="main">
    <article>
        <div class="article-inner">
            

            <header class="article-header">
    
    <h1 class="article-title" itemprop="name">
	<a href="http://darrelltunnell.net/blog/2017/01/24/csla-and-asp.net-core/" class="permalink">CSLA and ASP.NET Core</a>
    </h1>
	<time datetime="2017-01-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">2017-01-24</time>
    <div class="article-meta">

        
    </div>
</header>


            <div class="article-entry" itemprop="articleBody">
                <p>I am a fan of CSLA and I recently came accross a need to make a shiny CSLA business layer work nicely within the context of an ASP.NET Core application.
This post is aimed at CSLA developers with a similar need.
As of the <a href="https://www.nuget.org/packages/CSLA-Core/4.6.500">current release</a>, there are a few things that you will need to take care of in order to get CSLA working smoothly, and I will cover those in this post.
</p>

<h3 id="csla-applicationcontext">Csla.ApplicationContext</h3>

<p>CSLA developers should be familiar with <code>Csla.ApplicationContext</code> which provides the means to access useful context, as well as the current <code>User</code> / <code>IPrinciple</code>.
However when running under ASP.NET Core, <code>Csla.ApplicationContext</code> doesn&rsquo;t work correctly - as CSLA decides that your application is not a web application (as <code>HttpContext.Current</code> is null under ASP.NET Core) and so
it ends up storing things that should be stored in <code>HttpContext</code> on the current <code>Thread</code> instead.</p>

<p>To overcome this, however, is pretty straight forward. You just need to implement an extensibility point that Rocky has provided, called an <code>IContextManager</code>.</p>

<h3 id="icontextmanager-for-asp-net-core">IContextManager for ASP.NET Core.</h3>

<p>Here is an implementation of an <code>IContextManager</code> that resolves the <code>HttpContext</code> using the <code>IHttpContextAccessor</code> instead:</p>

<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  1</span>  /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  2</span>    /// Application context manager that uses HttpContextAccessor whenr esolving HttpContext
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  3</span>    /// to store context values.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  4</span>    /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  5</span>    public class HttpContextAccessorContextMananger : IContextManager
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  6</span>    {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  7</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  8</span>        private const string _localContextName = &#34;Csla.LocalContext&#34;;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">  9</span>        private const string _clientContextName = &#34;Csla.ClientContext&#34;;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 10</span>        private const string _globalContextName = &#34;Csla.GlobalContext&#34;;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 11</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 12</span>        private readonly IServiceProvider _serviceProvider;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 13</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 14</span>        public HttpContextAccessorContextMananger(IServiceProvider serviceProvider)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 15</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 16</span>            _serviceProvider = serviceProvider;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 17</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 18</span>      
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 19</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 20</span>        protected virtual HttpContext GetHttpContext()
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 21</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 22</span>            var httpContextAccessor = (IHttpContextAccessor)_serviceProvider.GetService(typeof(IHttpContextAccessor));
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 23</span>            if (httpContextAccessor != null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 24</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 25</span>                if (httpContextAccessor.HttpContext == null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 26</span>                {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 27</span>                    //   Debugger.Break();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 28</span>                }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 29</span>                return httpContextAccessor.HttpContext;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 30</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 31</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 32</span>            // Debugger.Break();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 33</span>            return null;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 34</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 35</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 36</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 37</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 38</span>        /// Gets a value indicating whether this
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 39</span>        /// context manager is valid for use in
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 40</span>        /// the current environment.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 41</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 42</span>        public bool IsValid
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 43</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 44</span>            get
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 45</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 46</span>                return GetHttpContext() != null;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 47</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 48</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 49</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 50</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 51</span>        /// Gets the current principal.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 52</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 53</span>        public System.Security.Principal.IPrincipal GetUser()
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 54</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 55</span>            return GetHttpContext()?.User;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 56</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 57</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 58</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 59</span>        /// Sets the current principal.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 60</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 61</span>        /// &lt;param name=&#34;principal&#34;&gt;Principal object.&lt;/param&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 62</span>        public void SetUser(System.Security.Principal.IPrincipal principal)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 63</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 64</span>            var context = GetHttpContext();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 65</span>            if (context != null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 66</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 67</span>                context.User = (ClaimsPrincipal)principal;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 68</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 69</span>            else
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 70</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 71</span>                //  Debugger.Break();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 72</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 73</span>           
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 74</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 75</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 76</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 77</span>        /// Gets the local context.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 78</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 79</span>        public ContextDictionary GetLocalContext()
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 80</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 81</span>            return (ContextDictionary)GetHttpContext()?.Items[_localContextName];
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 82</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 83</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 84</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 85</span>        /// Sets the local context.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 86</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 87</span>        /// &lt;param name=&#34;localContext&#34;&gt;Local context.&lt;/param&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 88</span>        public void SetLocalContext(ContextDictionary localContext)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 89</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 90</span>            var context = GetHttpContext();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 91</span>            if (context != null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 92</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 93</span>                context.Items[_localContextName] = localContext;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 94</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 95</span>            else
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 96</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 97</span>              //  Debugger.Break();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 98</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 99</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">100</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">101</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">102</span>        /// Gets the client context.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">103</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">104</span>        public ContextDictionary GetClientContext()
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">105</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">106</span>            return (ContextDictionary)GetHttpContext()?.Items[_clientContextName];
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">107</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">108</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">109</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">110</span>        /// Sets the client context.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">111</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">112</span>        /// &lt;param name=&#34;clientContext&#34;&gt;Client context.&lt;/param&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">113</span>        public void SetClientContext(ContextDictionary clientContext)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">114</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">115</span>            var context = GetHttpContext();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">116</span>            if (context != null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">117</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">118</span>                context.Items[_clientContextName] = clientContext;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">119</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">120</span>            else
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">121</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">122</span>              //  Debugger.Break();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">123</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">124</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">125</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">126</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">127</span>        /// Gets the global context.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">128</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">129</span>        public ContextDictionary GetGlobalContext()
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">130</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">131</span>            return (ContextDictionary)GetHttpContext()?.Items[_globalContextName];
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">132</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">133</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">134</span>        /// &lt;summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">135</span>        /// Sets the global context.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">136</span>        /// &lt;/summary&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">137</span>        /// &lt;param name=&#34;globalContext&#34;&gt;Global context.&lt;/param&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">138</span>        public void SetGlobalContext(ContextDictionary globalContext)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">139</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">140</span>            var context = GetHttpContext();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">141</span>            if (context != null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">142</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">143</span>                context.Items[_globalContextName] = globalContext;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">144</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">145</span>            else
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">146</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">147</span>              //  Debugger.Break();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">148</span>            }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">149</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">150</span>    }</code></pre>
</div>

<h3 id="configuring-csla">Configuring CSLA</h3>

<p>Now that you have this implementation, you need to tell CSLA to use it. In the ASP.NET Core world, we are used to nice extension methods that we can use in our
<code>startup.cs</code> classes, in order to configure things fluently.</p>

<p>CSLA doesn&rsquo;t provide one of these just yet, but we can create one fairly easily:</p>

<p><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 1</span> public static class CslaConfiguration
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 2</span>    {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 3</span>        public static IServiceCollection ConfigureCsla(this IServiceCollection services, Action&lt;CslaOptions, IServiceProvider&gt; setupAction = null)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 4</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 5</span>            services.AddSingleton&lt;CslaOptions&gt;((sp) =&gt;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 6</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 7</span>                var options = new CslaOptions();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 8</span>                setupAction?.Invoke(options, sp);
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 9</span>                return options;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">10</span>            });
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">11</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">12</span>            return services;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">13</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">14</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">15</span>        public static IApplicationBuilder UseCsla(this IApplicationBuilder appBuilder)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">16</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">17</span>            // grab the options
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">18</span>            var options = appBuilder.ApplicationServices.GetRequiredService&lt;CslaOptions&gt;();
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">19</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">20</span>            // configure csla according to options.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">21</span>            Csla.Server.FactoryDataPortal.FactoryLoader = options.ObjectFactoryLoader;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">22</span>            Csla.ApplicationContext.WebContextManager = options.WebContextManager ?? new HttpContextAccessorContextMananger(appBuilder.ApplicationServices);
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">23</span>            
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">24</span>            return appBuilder;
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">25</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">26</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">27</span>        public class CslaOptions
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">28</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">29</span>            public IObjectFactoryLoader ObjectFactoryLoader { get; set; }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">30</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">31</span>            public IContextManager WebContextManager { get; set; }           
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">32</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">33</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">34</span>    }</code></pre>
</div></p>

<p>So we can now configure CSLA in our <code>startup.cs</code> like this:</p>

<p><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 1</span>    public class Startup
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 2</span>    {              
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 3</span>       
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 4</span>        // This method gets called by the runtime. Use this method to add services to the container.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 5</span>        public void ConfigureServices(IServiceCollection services)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 6</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 7</span>            // Configure Csla
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 8</span>           services.ConfigureCsla((options, sp) =&gt; {               
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;"> 9</span>                // could configure other CSLA hooks / options here in future.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">10</span>            });
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">11</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">12</span>        }
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">13</span>
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">14</span>        // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">15</span>        public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">16</span>        {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">17</span>            app.UseCookieAuthentication(new CookieAuthenticationOptions
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">18</span>            {
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">19</span>                AuthenticationType = DefaultAuthenticationTypes.ApplicationCookie,
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">20</span>                LoginPath = new PathString(&#34;/Account/Login&#34;)
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">21</span>            });
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">22</span>           app.UseCsla();      
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">23</span>        }        
<span style="color:#727272;margin-right:0.4em;padding:00.4em00.4em;">24</span>    }</code></pre>
</div></p>

<p>CSLA <code>ApplicationContext</code> should now behave correctly thanks to the custom <code>IContextManager</code> for ASP.NET Core.</p>

<h3 id="conclusion">Conclusion</h3>

<p>I also went a few steps further in my particular application, to enable DI to flow from my ASP.NET Core <code>IServiceProvider</code> into my CSLA business tier, but that&rsquo;s a topic for another article.</p>

<p>I suspect that Rocky will release improved support for ASP.NET Core in the future, so that this post becomes obsolete.
Until then, Bon Appétit!</p>
            </div>

            <div class="tweet-footer">
<a href="http://twitter.com/share?url=http%3a%2f%2fdarrelltunnell.net%2fblog%2f2017%2f01%2f24%2fcsla-and-asp.net-core%2f&text=CSLA%20and%20ASP.NET%20Core" target="_blank" title="Twitter" >
<span class="tweet-botton">
    	<i class="fa fa-twitter" aria-hidden="true"></i>
    	   Compose new Tweet 
    </span>
    </a>
</div>

<footer class="article-footer">

    
    

    <a href="http://darrelltunnell.net/blog/2017/01/24/csla-and-asp.net-core//#disqus_thread" class="article-comment-link">
        
    </a>
    
</footer>

        </div>

        


  <script type="text/javascript">
   talaria.init({REPOSITORY_NAME: 'syui.gitlab.io-comment',
                 GITHUB_USERNAME: 'mba-hack'});
  </script>
    </article>

    <section id="comments">

        <div id="disqus_thread">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "darrelltunnellsblog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </section>
</section>

    <aside id="sidebar">
    <div class="widget-wrap">
<input id="search" type="text" placeholder="search">
<ul id="results">
</ul>
<script type="text/javascript" src="http://darrelltunnell.net/js/search.js"></script>
<script type="text/javascript" src="http://darrelltunnell.net/bower_components/lunr.js/lunr.min.js"></script>
</div>

    


    

    

    
</aside>

</div>
</div>

<footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
	<footer id="footer-left">
	    &copy; 2017 <a href="https://github.com/syui">syui</a>. <br>
	    
	</footer>
	    <footer id="footer-center"> <a href="#"><span class="icon-phoenix_logo"></span></a>  </footer>
	   <footer id="footer-right"> <a href="">Reference</a> <a href="">Keybind</a> <a href="">Command</a> <a href="">API</a>  </footer>
    </div>
  </div>
</footer>

</body>
</html>
